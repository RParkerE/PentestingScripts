#!/usr/bin/python3

import socket
import argparse
from scapy.all import *
import concurrent.futures
from colorama import init, Fore

def grabBanner(tgtHost: str, tgtPort: int):
	GREEN = Fore.GREEN
	RED   = Fore.RED
	WHITE = Fore.WHITE

	try:
		serverTCPSocket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
		serverTCPSocket.connect((tgtHost, tgtPort))
		serverTCPSocket.send(bytes('GET HTTP/2 \r\n', encoding='utf8'))
		banner = serverTCPSocket.recv(2048)
		print(f'{WHITE} [*] {tgtPort} | BANNER : ')
		print(f'{WHITE} {banner.decode("utf8")}')
	except Exception as e:  
		print(f'{RED} [-] {tgtPort} | BANNER ERROR : {e.upper()}')
	except socket.timeout:
		print(f'{RED} [-] {tgtPort} | TIMEOUT')
	finally:
		serverTCPSocket.close()

def connScan(tgtHost: str, tgtPort: int, scan: str = 'S'):
	GREEN = Fore.GREEN
	RED   = Fore.RED

	srcPort = RandShort()

	if scan == 'S':
		flag = 'S'
	
	if scan == 'X':
		flag = 'FPU'

	try:
		pkt = sr1(IP(dst=tgtHost)/TCP(sport=srcPort, dport=tgtPort, flags=flag), timeout=2, verbose=0)
		if pkt != None:
			if pkt.haslayer(TCP):
				if pkt.getlayer(TCP).flags == 0x14:
					print(f'{RED} [-] {tgtPort}/TCP CLOSED')
				elif pkt.getlayer(TCP).flags == 0x12:
					print(f'{GREEN} [+] {tgtPort}/TCP \tOPEN')
				else:
					print(f'{GREEN} [+] {tgtPort}/TCP \tFILTERED')
			elif pkt.haslayer(ICMP):
				print(f'{GREEN} [+] {tgtPort}/ICMP \tRESP|FILTERED')
			else:
				print(f'{GREEN} [+] {tgtPort}/TCP \tUNKNOWN RESP')
		else:
			try:
				pkt = sr1(IP(dst=tgtHost)/UDP(sport=srcPort, dport=tgtPort), timeout=2, verbose=0)
				if pkt == None:
					print(f'{GREEN} [+] {tgtPort}/UDP \tOPEN|FILTERED')
				else:
					if pkt.haslayer(ICMP):
						print(f'{RED} [-] {tgtPort}/UDP CLOSED')
					elif pkt.haslayer(UDP):
						print(f'{GREEN} [+] {tgtPort}/UDP \tOPEN|FILTERED')
					else:
						print(f'{GREEN} [+] {tgtPort}/UDP \tUNKNOWN RESP')
			except Exception as udpE:
				print(f'{RED} [-] {tgtPort}/UDP CLOSED | Reason: {udpE}')
	except Exception as tcpE:
		print(f'{RED} [-] {tgtPort}/TCP CLOSED | Reason: {tcpE}')

def portScan(tgtHost: str, tgtPorts: str):
	GREEN = Fore.GREEN
	RED   = Fore.RED

	try:
		tgtIP = socket.gethostbyname(tgtHost)
		icmp = IP(dst=tgtIP)/ICMP()
		resp = sr1(icmp, timeout=5, verbose=0)
		print(f'{GREEN} [+] Scan Results For: {tgtIP}')
	except Exception as e:
		print(f'{RED} [-] Cannot resolve {tgtHost}: Unknown Host Due To {e}')
		exit(0)

	socket.setdefaulttimeout(2)
	with concurrent.futures.ThreadPoolExecutor(max_workers=1) as executor:
		for tgtPort in tgtPorts:
			future_one = executor.submit(connScan, tgtHost, int(tgtPort))
			future_two = executor.submit(grabBanner, tgtHost, int(tgtPort))

def main():
	init()

	parser = argparse.ArgumentParser(usage='Usage of scanner: --H <target host> --P <target port(s)>')
	parser.add_argument('--H', dest='tgtHost', type=str, help='specify target host')
	parser.add_argument('--P', dest='tgtPorts', type=str, help='specify target port(s) seperated by comma')
	args = parser.parse_args()
	tgtHost = args.tgtHost
	tgtPorts = str(args.tgtPorts).split(',')
	if (tgtHost == None) | (tgtPorts[0] == 'None'):
		print(parser.usage)
		exit(0)
	portScan(tgtHost, tgtPorts)

if __name__ == '__main__':
	main()